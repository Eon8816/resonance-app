<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共振 Resonance v1.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            -webkit-tap-highlight-color: transparent;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .fade-in { animation: fadeIn 1s ease-in-out; }
        .fade-out { animation: fadeOut 1s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        #emotion-card, #detail-card, #my-echoes-page {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        textarea::placeholder, input::placeholder { color: #9ca3af; }
        .content-list::-webkit-scrollbar { width: 4px; }
        .content-list::-webkit-scrollbar-track { background: transparent; }
        .content-list::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.5); border-radius: 2px; }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen overflow-hidden p-4 antialiased">

    <div id="star-container" class="absolute top-0 left-0 w-full h-full z-0"></div>

    <div id="app-container" class="z-10 w-full max-w-md h-[90vh] flex flex-col">
        <header class="text-center p-2">
            <span id="anonymous-id-display" class="text-sm text-gray-400"></span>
        </header>

        <div class="flex-grow relative">
            <div id="message-display" class="absolute inset-0 flex items-center justify-center text-lg text-gray-400 z-50">正在连接星海...</div>
            
            <div id="drift-page" class="hidden w-full h-full flex flex-col items-center justify-center">
                <div id="emotion-card" class="w-full h-full flex flex-col justify-center p-8 bg-black/20 rounded-2xl shadow-lg cursor-pointer transition-transform duration-300 hover:scale-[1.02]">
                    <p id="emotion-text" class="text-xl md:text-2xl leading-relaxed text-center flex-grow flex items-center justify-center"></p>
                    <div id="emotion-meta" class="text-center text-gray-400 text-sm mt-4"><span id="comment-count">评论 0</span></div>
                </div>
                <div class="mt-6"><button id="resonate-button" class="bg-indigo-500/50 hover:bg-indigo-500/80 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg">回响</button></div>
            </div>

            <div id="project-page" class="hidden w-full h-full flex flex-col items-center justify-center">
                <textarea id="emotion-input" class="w-full h-full bg-black/20 rounded-2xl p-8 text-xl md:text-2xl leading-relaxed focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="在此处投射你的情绪、思绪或梦呓..."></textarea>
                <div class="mt-6"><button id="project-button" class="bg-teal-500/50 hover:bg-teal-500/80 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg">投入星海</button></div>
            </div>

            <div id="detail-page" class="hidden w-full h-full flex flex-col bg-black/20 rounded-2xl shadow-lg">
                <div id="detail-card" class="p-6 border-b border-gray-700">
                    <p id="detail-emotion-text" class="text-lg md:text-xl leading-relaxed"></p>
                    <p id="detail-author-id" class="text-right text-sm text-teal-400 mt-2"></p>
                </div>
                <div id="comment-list" class="flex-grow p-4 overflow-y-auto content-list"></div>
                <div class="p-4 border-t border-gray-700 flex gap-2">
                    <input id="comment-input" type="text" class="flex-grow bg-gray-800/50 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="留下你的回音...">
                    <button id="post-comment-button" class="bg-indigo-500/70 hover:bg-indigo-500 text-white font-bold p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
            
            <div id="my-echoes-page" class="hidden w-full h-full flex flex-col bg-black/20 rounded-2xl shadow-lg">
                <div class="p-4 border-b border-gray-700 text-center"><h2 class="text-xl">我的回响</h2></div>
                <div id="my-echoes-content" class="flex-grow p-4 overflow-y-auto content-list">
                    <h3 class="text-lg text-amber-300 mb-2">新消息</h3>
                    <div id="new-notifications-list"></div>
                    <h3 class="text-lg text-gray-400 mt-6 mb-2">我的星辰 (回响刷新)</h3>
                    <div id="my-posts-list"></div>
                    <h3 class="text-lg text-gray-400 mt-6 mb-2">往日消息</h3>
                    <div id="past-notifications-list"></div>
                </div>
            </div>
        </div>

        <nav id="navigation" class="w-full flex justify-center gap-4 py-4 mt-2">
            <button id="nav-back" class="hidden nav-button p-3 rounded-full bg-gray-700/50"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
            <button id="nav-drift" class="nav-button p-3 rounded-full bg-gray-700/50"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 12a10 10 0 0 0-7.53 16.82A10 10 0 0 1 12 12z"/></svg></button>
            <button id="nav-my-echoes" class="nav-button relative p-3 rounded-full bg-gray-700/50">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                <span id="notification-badge" class="notification-badge"></span>
            </button>
            <button id="nav-project" class="nav-button p-3 rounded-full bg-gray-700/50"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, increment, query, where, limit, orderBy, serverTimestamp, onSnapshot, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const DOM = {
            anonymousIdDisplay: document.getElementById('anonymous-id-display'),
            messageDisplay: document.getElementById('message-display'),
            pages: {
                drift: document.getElementById('drift-page'),
                project: document.getElementById('project-page'),
                detail: document.getElementById('detail-page'),
                myEchoes: document.getElementById('my-echoes-page'),
            },
            emotionCard: document.getElementById('emotion-card'),
            emotionText: document.getElementById('emotion-text'),
            commentCount: document.getElementById('comment-count'),
            resonateButton: document.getElementById('resonate-button'),
            emotionInput: document.getElementById('emotion-input'),
            projectButton: document.getElementById('project-button'),
            detailEmotionText: document.getElementById('detail-emotion-text'),
            detailAuthorId: document.getElementById('detail-author-id'),
            commentList: document.getElementById('comment-list'),
            commentInput: document.getElementById('comment-input'),
            postCommentButton: document.getElementById('post-comment-button'),
            myPostsList: document.getElementById('my-posts-list'),
            newNotificationsList: document.getElementById('new-notifications-list'),
            pastNotificationsList: document.getElementById('past-notifications-list'),
            notificationBadge: document.getElementById('notification-badge'),
            nav: {
                back: document.getElementById('nav-back'),
                drift: document.getElementById('nav-drift'),
                project: document.getElementById('nav-project'),
                myEchoes: document.getElementById('nav-my-echoes'),
            },
            starContainer: document.getElementById('star-container')
        };

        const firebaseConfig = {
          apiKey: "AIzaSyDi96c9kJK8p61xDNXGYrZ4iAkOw-cADkc",
          authDomain: "gongzhen-2025.firebaseapp.com",
          projectId: "gongzhen-2025",
          storageBucket: "gongzhen-2025.firebasestorage.app",
          messagingSenderId: "437765028034",
          appId: "1:437765028034:web:e84dda67b481d26543e35b",
          measurementId: "G-H74PG2E7X8"
        };
        const appId = 'resonance-v7-stable'; // Updated app ID for new version

        let app, auth, db, userId, anonymousId, emotionsCol, notificationsCol;
        let currentEmotion = null;
        let unsubscribeComments = null;
        let unsubscribeNotifications = null;
        let countdownInterval = null;

        function generateAnonymousId() {
            const adjectives = ["漂流的", "安静的", "发光的", "遥远的", "沉思的", "孤独的", "温暖的"];
            const nouns = ["旅人", "星辰", "回音", "尘埃", "水母", "萤火", "幽灵"];
            return `${adjectives[Math.floor(Math.random() * adjectives.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}${Math.floor(Math.random() * 900 + 100)}`;
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        anonymousId = sessionStorage.getItem('anonymousId') || generateAnonymousId();
                        sessionStorage.setItem('anonymousId', anonymousId);
                        DOM.anonymousIdDisplay.textContent = `你的临时身份: ${anonymousId}`;
                        emotionsCol = collection(db, `artifacts/${appId}/public/data/emotions`);
                        notificationsCol = collection(db, `artifacts/${appId}/public/data/notifications`);
                        listenForNotifications();
                        await showDriftPage();
                    } else {
                        await signIn();
                    }
                });
            } catch (error) { console.error("Firebase Init Error:", error); showMessage("无法连接到星海。"); }
        }

        async function signIn() {
            try {
                await signInAnonymously(auth);
            } catch (error) { console.error("Sign-in Error:", error); showMessage("身份验证失败。"); }
        }

        function showPage(pageKey) {
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            Object.values(DOM.pages).forEach(p => p.classList.add('hidden'));
            DOM.pages[pageKey].classList.remove('hidden');
            
            const mainPages = ['drift', 'project', 'myEchoes'];
            const isDetailPage = !mainPages.includes(pageKey);
            
            DOM.nav.back.classList.toggle('hidden', !isDetailPage);
            mainPages.forEach(key => DOM.nav[key]?.classList.toggle('hidden', isDetailPage));
            
            Object.keys(DOM.nav).forEach(key => {
                if(DOM.nav[key]) DOM.nav[key].dataset.active = false;
            });
            if(DOM.nav[pageKey]) DOM.nav[pageKey].dataset.active = true;
        }
        
        function showMessage(text) {
            DOM.messageDisplay.textContent = text;
            DOM.messageDisplay.classList.remove('hidden');
            Object.values(DOM.pages).forEach(p => p.classList.add('hidden'));
        }

        async function showDriftPage() {
            showPage('drift');
            if (unsubscribeComments) unsubscribeComments();
            if (!currentEmotion) await fetchEmotion();
            else {
                DOM.messageDisplay.classList.add('hidden');
                DOM.pages.drift.classList.remove('hidden');
            }
            DOM.pages.drift.classList.add('fade-in');
        }

        function showProjectPage() { showPage('project'); DOM.pages.project.classList.add('fade-in'); }

        async function showDetailPage(emotionData) {
            currentEmotion = emotionData;
            showPage('detail');
            DOM.pages.detail.classList.add('fade-in');
            DOM.detailEmotionText.textContent = currentEmotion.text;
            DOM.detailAuthorId.textContent = `—— ${currentEmotion.authorId || '一位匿名的星主'}`;
            listenForComments();
        }

        function updateAllCountdowns() {
            const countdownElements = DOM.myPostsList.querySelectorAll('[data-expires-at]');
            const now = Date.now();

            countdownElements.forEach(el => {
                const expiresAt = parseInt(el.dataset.expiresAt, 10);
                const timeLeft = expiresAt - now;

                if (timeLeft <= 0) {
                    el.textContent = "回响已消散";
                    el.parentElement.parentElement.style.opacity = '0.5';
                } else {
                    const hours = Math.floor((timeLeft / (1000 * 60 * 60)));
                    const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                    const seconds = Math.floor((timeLeft / 1000) % 60);
                    el.textContent = `剩余: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            });
        }

        async function showMyEchoesPage() {
            showPage('myEchoes');
            DOM.newNotificationsList.innerHTML = '';
            DOM.pastNotificationsList.innerHTML = '';
            DOM.myPostsList.innerHTML = '<p class="text-center text-gray-400">正在加载你的星辰...</p>';
            
            const allPosts = JSON.parse(localStorage.getItem('myPosts')) || [];
            const now = Date.now();
            const validPosts = allPosts.filter(post => post.expiresAt > now);
            localStorage.setItem('myPosts', JSON.stringify(validPosts));

            if (validPosts.length === 0) {
                DOM.myPostsList.innerHTML = '<p class="text-center text-gray-400">24小时内没有需要回响的星辰...</p>';
            } else {
                DOM.myPostsList.innerHTML = '';
                for (const post of validPosts.sort((a, b) => b.expiresAt - a.expiresAt)) {
                    const docRef = doc(emotionsCol, post.id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const postData = { id: docSnap.id, ...docSnap.data() };
                        const postEl = document.createElement('div');
                        postEl.className = 'p-4 my-2 rounded-lg bg-gray-800/50 cursor-pointer hover:bg-gray-800/80 transition-opacity';
                        postEl.innerHTML = `
                            <p class="truncate">${postData.text}</p>
                            <div class="flex justify-between items-center mt-2 text-xs">
                                <span class="text-gray-400">评论: ${postData.commentCount || 0}</span>
                                <span class="text-amber-400" data-expires-at="${post.expiresAt}"></span>
                            </div>
                        `;
                        postEl.addEventListener('click', () => showDetailPage(postData));
                        DOM.myPostsList.appendChild(postEl);
                    }
                }
                updateAllCountdowns();
                countdownInterval = setInterval(updateAllCountdowns, 1000);
            }

            const unreadNotifs = JSON.parse(localStorage.getItem('unreadNotifications')) || [];
            const pastNotifs = JSON.parse(localStorage.getItem('pastNotifications')) || [];

            DOM.newNotificationsList.innerHTML = unreadNotifs.length > 0 ? '' : '<p class="text-gray-500 text-sm">暂无新消息</p>';
            unreadNotifs.forEach(n => renderNotification(n, DOM.newNotificationsList));

            DOM.pastNotificationsList.innerHTML = pastNotifs.length > 0 ? '' : '<p class="text-gray-500 text-sm">暂无往日消息</p>';
            pastNotifs.forEach(n => renderNotification(n, DOM.pastNotificationsList));

            if (unreadNotifs.length > 0) {
                localStorage.setItem('pastNotifications', JSON.stringify([...pastNotifs, ...unreadNotifs]));
                localStorage.setItem('unreadNotifications', JSON.stringify([]));
                DOM.notificationBadge.style.display = 'none';
            }
        }
        
        function renderNotification(notification, listElement) {
            const notificationEl = document.createElement('div');
            notificationEl.className = 'p-3 my-2 rounded-lg bg-gray-800/50 cursor-pointer hover:bg-gray-800/80';
            notificationEl.innerHTML = `
                <p class="text-sm">“<span class="text-amber-300">${notification.commenterId || '有位旅人'}</span>” 回响了你的星辰 “<span class="italic text-gray-300">${notification.postSnippet}...</span>”</p>
                <p class="text-md mt-1 pl-2 border-l-2 border-amber-400">${notification.commentText}</p>
            `;
            notificationEl.addEventListener('click', async () => {
                const postRef = doc(emotionsCol, notification.postId);
                const postSnap = await getDoc(postRef);
                if(postSnap.exists()) {
                    showDetailPage({id: postSnap.id, ...postSnap.data()});
                }
            });
            listElement.appendChild(notificationEl);
        }

        async function fetchEmotion() {
            if (!emotionsCol) { showMessage("数据库未连接。"); return; }
            showMessage("正在星海中漂流...");
            try {
                const randomId = doc(collection(db, '_')).id;
                let q = query(emotionsCol, where('__name__', '>=', randomId), orderBy('__name__'), limit(1));
                let querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    q = query(emotionsCol, orderBy('__name__'), limit(1));
                    querySnapshot = await getDocs(q);
                }
                if (!querySnapshot.empty) {
                    const emotionDoc = querySnapshot.docs[0];
                    currentEmotion = { id: emotionDoc.id, ...emotionDoc.data() };
                    DOM.emotionText.textContent = currentEmotion.text;
                    DOM.commentCount.textContent = `评论 ${currentEmotion.commentCount || 0}`;
                } else {
                    currentEmotion = null;
                    DOM.emotionText.textContent = "星海此刻一片沉寂，不如由你来投射第一束光吧。";
                    DOM.commentCount.textContent = '评论 0';
                }
            } catch (error) {
                console.error("Error fetching emotion:", error);
                currentEmotion = null;
                DOM.emotionText.textContent = "在漂流中迷失了方向...";
            } finally {
                DOM.messageDisplay.classList.add('hidden');
                DOM.pages.drift.classList.remove('hidden');
            }
        }

        async function projectEmotion() {
            const text = DOM.emotionInput.value.trim();
            if (!text) return;
            DOM.projectButton.disabled = true;
            DOM.projectButton.textContent = "投射中...";
            try {
                const newDocRef = await addDoc(emotionsCol, { text, resonanceCount: 0, commentCount: 0, createdAt: serverTimestamp(), authorId: anonymousId });
                DOM.emotionInput.value = "";
                
                let myPosts = JSON.parse(localStorage.getItem('myPosts')) || [];
                myPosts.push({ id: newDocRef.id, expiresAt: Date.now() + 24 * 60 * 60 * 1000 });
                localStorage.setItem('myPosts', JSON.stringify(myPosts));

                const newEmotion = { id: newDocRef.id, text, authorId: anonymousId, commentCount: 0 };
                await showDetailPage(newEmotion);
            } catch (error) { console.error("Error projecting emotion:", error); } 
            finally { DOM.projectButton.disabled = false; DOM.projectButton.textContent = "投入星海"; }
        }

        async function resonateWithEmotion() {
            if (!currentEmotion) return;
            DOM.resonateButton.disabled = true;
            try {
                const emotionDocRef = doc(db, emotionsCol.path, currentEmotion.id);
                await updateDoc(emotionDocRef, { resonanceCount: increment(1) });
                DOM.emotionCard.classList.add('fade-out');
                setTimeout(async () => {
                    currentEmotion = null; 
                    await fetchEmotion(); 
                    DOM.emotionCard.classList.remove('fade-out');
                    DOM.resonateButton.disabled = false;
                }, 800);
            } catch (error) { console.error("Error resonating:", error); DOM.resonateButton.disabled = false; }
        }

        function listenForComments() {
            if (unsubscribeComments) unsubscribeComments();
            if (!currentEmotion || !currentEmotion.id) return;
            const commentsCol = collection(db, emotionsCol.path, currentEmotion.id, 'comments');
            const q = query(commentsCol, orderBy('createdAt', 'asc'));
            unsubscribeComments = onSnapshot(q, (snapshot) => {
                DOM.commentList.innerHTML = ''; 
                if (snapshot.empty) {
                    DOM.commentList.innerHTML = `<p class="text-center text-gray-500 p-4">还没有回音...</p>`;
                } else {
                    snapshot.forEach(doc => {
                        if (!currentEmotion) return;
                        const comment = doc.data();
                        const isAuthor = comment.authorId === currentEmotion.authorId;
                        const commentEl = document.createElement('div');
                        commentEl.className = `p-3 my-2 rounded-lg ${isAuthor ? 'bg-teal-500/10' : 'bg-gray-800/50'}`;
                        commentEl.innerHTML = `<p>${comment.text}</p><p class="text-xs text-right mt-1 ${isAuthor ? 'text-teal-400' : 'text-gray-400'}">${isAuthor ? `${comment.authorId} (星主)` : comment.authorId}</p>`;
                        DOM.commentList.appendChild(commentEl);
                    });
                    DOM.commentList.scrollTop = DOM.commentList.scrollHeight;
                }
            }, (error) => { console.error("Error listening for comments:", error); DOM.commentList.innerHTML = `<p class="text-center text-red-500 p-4">无法加载回音</p>`; });
        }

        function listenForNotifications() {
            const q = query(notificationsCol, where("recipientId", "==", anonymousId));
            onSnapshot(q, async (snapshot) => {
                if (snapshot.empty) return;

                const batch = writeBatch(db);
                let unreadNotifications = JSON.parse(localStorage.getItem('unreadNotifications')) || [];
                let newNotificationsFound = false;

                snapshot.forEach(doc => {
                    const notification = { id: doc.id, ...doc.data() };
                    if (notification.delivered === false) {
                        newNotificationsFound = true;
                        unreadNotifications.push(notification);
                        updateMyPostTimestamp(notification.postId);
                        const notifRef = doc(notificationsCol, notification.id);
                        batch.update(notifRef, { delivered: true });
                    }
                });

                if (newNotificationsFound) {
                    await batch.commit();
                    localStorage.setItem('unreadNotifications', JSON.stringify(unreadNotifications));
                    DOM.notificationBadge.style.display = 'block';
                }
            }, (error) => {
                console.error("Error in notifications snapshot listener:", error);
            });
        }

        function updateMyPostTimestamp(postId) {
            let myPosts = JSON.parse(localStorage.getItem('myPosts')) || [];
            const postIndex = myPosts.findIndex(p => p.id === postId);
            const twentyFourHours = 24 * 60 * 60 * 1000;
            if (postIndex > -1) {
                myPosts[postIndex].expiresAt = Date.now() + twentyFourHours;
            } else {
                myPosts.push({ id: postId, expiresAt: Date.now() + twentyFourHours });
            }
            localStorage.setItem('myPosts', JSON.stringify(myPosts));
        }

        async function postComment() {
            const text = DOM.commentInput.value.trim();
            if (!text || !currentEmotion) return;
            DOM.postCommentButton.disabled = true;
            try {
                const batch = writeBatch(db);

                const emotionDocRef = doc(emotionsCol, currentEmotion.id);
                batch.update(emotionDocRef, { commentCount: increment(1) });

                const commentsCol = collection(emotionDocRef, 'comments');
                const newCommentRef = doc(commentsCol);
                batch.set(newCommentRef, { text, authorId: anonymousId, createdAt: serverTimestamp() });

                if (currentEmotion.authorId && currentEmotion.authorId !== anonymousId) {
                    const newNotificationRef = doc(notificationsCol);
                    batch.set(newNotificationRef, {
                        recipientId: currentEmotion.authorId,
                        commenterId: anonymousId,
                        postId: currentEmotion.id,
                        postSnippet: currentEmotion.text.substring(0, 20),
                        commentText: text,
                        delivered: false,
                        createdAt: serverTimestamp()
                    });
                }
                
                await batch.commit();
                DOM.commentInput.value = '';

            } catch (error) { 
                console.error("Error posting comment:", error);
            } 
            finally { 
                DOM.postCommentButton.disabled = false; 
            }
        }

        function createStars() {
            if (DOM.starContainer.children.length > 0) return;
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                DOM.starContainer.appendChild(star);
            }
        }

        DOM.nav.drift.addEventListener('click', showDriftPage);
        DOM.nav.project.addEventListener('click', showProjectPage);
        DOM.nav.myEchoes.addEventListener('click', showMyEchoesPage);
        DOM.nav.back.addEventListener('click', () => {
            currentEmotion = null; 
            showDriftPage();
        });
        DOM.projectButton.addEventListener('click', projectEmotion);
        DOM.resonateButton.addEventListener('click', resonateWithEmotion);
        DOM.emotionCard.addEventListener('click', () => { if(currentEmotion) showDetailPage(currentEmotion); });
        DOM.postCommentButton.addEventListener('click', postComment);
        DOM.commentInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') postComment(); });

        window.onload = () => { createStars(); initializeFirebase(); };
    </script>
</body>
</html>
