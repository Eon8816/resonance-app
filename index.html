<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共振 Resonance v1.2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            -webkit-tap-highlight-color: transparent;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .fade-in { animation: fadeIn 1s ease-in-out; }
        .fade-out { animation: fadeOut 1s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        #emotion-card, #detail-card {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        textarea::placeholder, input::placeholder { color: #9ca3af; }
        /* Custom scrollbar for comments */
        .comment-list::-webkit-scrollbar { width: 4px; }
        .comment-list::-webkit-scrollbar-track { background: transparent; }
        .comment-list::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.5); border-radius: 2px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen overflow-hidden p-4 antialiased">

    <!-- Starry background -->
    <div id="star-container" class="absolute top-0 left-0 w-full h-full z-0"></div>

    <!-- Main Content Container -->
    <div id="app-container" class="z-10 w-full max-w-md h-[90vh] flex flex-col">

        <!-- Header with User's Anonymous ID -->
        <header class="text-center p-2">
            <span id="anonymous-id-display" class="text-sm text-gray-400"></span>
        </header>

        <!-- Page Container -->
        <div class="flex-grow relative">
            <!-- Loading/Message Display -->
            <div id="message-display" class="absolute inset-0 flex items-center justify-center text-lg text-gray-400 z-50">
                正在连接星海...
            </div>

            <!-- Drift Page -->
            <div id="drift-page" class="hidden w-full h-full flex flex-col items-center justify-center">
                <div id="emotion-card" class="w-full h-full flex flex-col justify-center p-8 bg-black/20 rounded-2xl shadow-lg cursor-pointer transition-transform duration-300 hover:scale-[1.02]">
                    <p id="emotion-text" class="text-xl md:text-2xl leading-relaxed text-center flex-grow flex items-center justify-center"></p>
                    <div id="emotion-meta" class="text-center text-gray-400 text-sm mt-4">
                        <span id="comment-count">评论 0</span>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="resonate-button" class="bg-indigo-500/50 hover:bg-indigo-500/80 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg">
                        回响
                    </button>
                </div>
            </div>

            <!-- Project Page -->
            <div id="project-page" class="hidden w-full h-full flex flex-col items-center justify-center">
                <textarea id="emotion-input" class="w-full h-full bg-black/20 rounded-2xl p-8 text-xl md:text-2xl leading-relaxed focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all duration-300" placeholder="在此处投射你的情绪、思绪或梦呓..."></textarea>
                <div class="mt-6">
                    <button id="project-button" class="bg-teal-500/50 hover:bg-teal-500/80 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg">
                        投入星海
                    </button>
                </div>
            </div>

            <!-- Detail Page (for comments) -->
            <div id="detail-page" class="hidden w-full h-full flex flex-col bg-black/20 rounded-2xl shadow-lg">
                <div id="detail-card" class="p-6 border-b border-gray-700">
                    <p id="detail-emotion-text" class="text-lg md:text-xl leading-relaxed"></p>
                    <p id="detail-author-id" class="text-right text-sm text-teal-400 mt-2"></p>
                </div>
                <div id="comment-list" class="flex-grow p-4 overflow-y-auto comment-list">
                    <!-- Comments will be injected here -->
                </div>
                <div class="p-4 border-t border-gray-700 flex gap-2">
                    <input id="comment-input" type="text" class="flex-grow bg-gray-800/50 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="留下你的回音...">
                    <button id="post-comment-button" class="bg-indigo-500/70 hover:bg-indigo-500 text-white font-bold p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav id="navigation" class="w-full flex justify-center gap-4 py-4 mt-2">
            <button id="nav-back" class="hidden nav-button p-3 rounded-full bg-gray-700/50">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
            </button>
            <button id="nav-drift" class="nav-button p-3 rounded-full bg-gray-700/50 data-[active=true]:bg-indigo-500/80 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 12a10 10 0 0 0-7.53 16.82A10 10 0 0 1 12 12z"/></svg>
            </button>
            <button id="nav-project" class="nav-button p-3 rounded-full bg-gray-700/50 data-[active=true]:bg-teal-500/80 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 5l0 14"/><path d="M19 12l-7 7-7-7"/></svg>
            </button>
        </nav>
    </div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, increment, query, where, limit, orderBy, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const anonymousIdDisplay = document.getElementById('anonymous-id-display');
        const messageDisplay = document.getElementById('message-display');
        const driftPage = document.getElementById('drift-page');
        const projectPage = document.getElementById('project-page');
        const detailPage = document.getElementById('detail-page');
        const emotionCard = document.getElementById('emotion-card');
        const emotionText = document.getElementById('emotion-text');
        const commentCount = document.getElementById('comment-count');
        const resonateButton = document.getElementById('resonate-button');
        const emotionInput = document.getElementById('emotion-input');
        const projectButton = document.getElementById('project-button');
        const detailEmotionText = document.getElementById('detail-emotion-text');
        const detailAuthorId = document.getElementById('detail-author-id');
        const commentList = document.getElementById('comment-list');
        const commentInput = document.getElementById('comment-input');
        const postCommentButton = document.getElementById('post-comment-button');
        const navDrift = document.getElementById('nav-drift');
        const navProject = document.getElementById('nav-project');
        const navBack = document.getElementById('nav-back');
        const starContainer = document.getElementById('star-container');

        // --- Firebase Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'resonance-v2';

        // --- App State ---
        let app, auth, db, userId, anonymousId, emotionsCol;
        let currentEmotion = null;
        let unsubscribeComments = null;

        // --- Anonymous ID Generation ---
        function generateAnonymousId() {
            const adjectives = ["漂流的", "安静的", "发光的", "遥远的", "沉思的", "孤独的", "温暖的"];
            const nouns = ["旅人", "星辰", "回音", "尘埃", "水母", "萤火", "幽灵"];
            const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            return `${randomAdj}${randomNoun}${Math.floor(Math.random() * 900 + 100)}`;
        }

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        anonymousId = sessionStorage.getItem('anonymousId');
                        if (!anonymousId) {
                            anonymousId = generateAnonymousId();
                            sessionStorage.setItem('anonymousId', anonymousId);
                        }
                        anonymousIdDisplay.textContent = `你的临时身份: ${anonymousId}`;

                        const collectionPath = `artifacts/${appId}/public/data/emotions`;
                        emotionsCol = collection(db, collectionPath);
                        await showDriftPage();
                    } else {
                        await signIn();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showMessage("无法连接到星海。请刷新重试。");
            }
        }

        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Sign-in Error:", error);
                showMessage("身份验证失败。");
            }
        }

        // --- UI Navigation ---
        function showPage(pageId) {
            [driftPage, projectPage, detailPage].forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            const isDetailPage = pageId === 'detail-page';
            navBack.classList.toggle('hidden', !isDetailPage);
            [navDrift, navProject].forEach(b => b.classList.toggle('hidden', isDetailPage));
        }
        
        function showMessage(text) {
            messageDisplay.textContent = text;
            messageDisplay.classList.remove('hidden');
            [driftPage, projectPage, detailPage].forEach(p => p.classList.add('hidden'));
        }

        async function showDriftPage() {
            showPage('drift-page');
            navDrift.dataset.active = true;
            navProject.dataset.active = false;
            
            if (unsubscribeComments) unsubscribeComments();

            if (!currentEmotion) {
                await fetchEmotion();
            } else {
                messageDisplay.classList.add('hidden');
                driftPage.classList.remove('hidden');
            }
            driftPage.classList.add('fade-in');
        }

        function showProjectPage() {
            showPage('project-page');
            navDrift.dataset.active = false;
            navProject.dataset.active = true;
            projectPage.classList.add('fade-in');
        }

        async function showDetailPage() {
            if (!currentEmotion) return;
            showPage('detail-page');
            detailPage.classList.add('fade-in');

            detailEmotionText.textContent = currentEmotion.text;
            detailAuthorId.textContent = `—— ${currentEmotion.authorId || '一位匿名的星主'}`;
            
            listenForComments();
        }

        // --- Firestore Logic ---
        async function fetchEmotion() {
            if (!emotionsCol) { 
                showMessage("数据库未连接。"); 
                return; 
            }
            showMessage("正在星海中漂流...");
            
            try {
                const randomId = doc(collection(db, '_')).id;
                let q = query(emotionsCol, where('__name__', '>=', randomId), orderBy('__name__'), limit(1));
                let querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    q = query(emotionsCol, orderBy('__name__'), limit(1));
                    querySnapshot = await getDocs(q);
                }
                
                if (!querySnapshot.empty) {
                    const emotionDoc = querySnapshot.docs[0];
                    currentEmotion = { id: emotionDoc.id, ...emotionDoc.data() };
                    emotionText.textContent = currentEmotion.text;
                    commentCount.textContent = `评论 ${currentEmotion.commentCount || 0}`;
                } else {
                    currentEmotion = null;
                    emotionText.textContent = "星海此刻一片沉寂，不如由你来投射第一束光吧。";
                    commentCount.textContent = '评论 0';
                }
            } catch (error) {
                console.error("Error fetching emotion:", error);
                currentEmotion = null;
                emotionText.textContent = "在漂流中迷失了方向...请稍后再试。";
                commentCount.textContent = '';
            } finally {
                messageDisplay.classList.add('hidden');
                driftPage.classList.remove('hidden');
            }
        }

        async function projectEmotion() {
            const text = emotionInput.value.trim();
            if (!text) return;
            projectButton.disabled = true;
            projectButton.textContent = "投射中...";

            try {
                const newDocRef = await addDoc(emotionsCol, {
                    text: text,
                    resonanceCount: 0,
                    commentCount: 0,
                    createdAt: serverTimestamp(),
                    authorId: anonymousId
                });
                emotionInput.value = "";
                currentEmotion = { id: newDocRef.id, text, authorId: anonymousId, commentCount: 0 };
                await showDetailPage();
            } catch (error) {
                console.error("Error projecting emotion:", error);
            } finally {
                projectButton.disabled = false;
                projectButton.textContent = "投入星海";
            }
        }

        async function resonateWithEmotion() {
            if (!currentEmotion) return;
            resonateButton.disabled = true;
            try {
                const emotionDocRef = doc(db, emotionsCol.path, currentEmotion.id);
                await updateDoc(emotionDocRef, { resonanceCount: increment(1) });
                
                emotionCard.classList.add('fade-out');
                setTimeout(async () => {
                    currentEmotion = null; 
                    await fetchEmotion(); 
                    emotionCard.classList.remove('fade-out');
                    resonateButton.disabled = false;
                }, 800);
            } catch (error) {
                console.error("Error resonating:", error);
                resonateButton.disabled = false;
            }
        }

        function listenForComments() {
            if (unsubscribeComments) unsubscribeComments();
            if (!currentEmotion || !currentEmotion.id) return;

            const commentsCol = collection(db, emotionsCol.path, currentEmotion.id, 'comments');
            const q = query(commentsCol, orderBy('createdAt', 'asc'));

            unsubscribeComments = onSnapshot(q, (snapshot) => {
                commentList.innerHTML = ''; 
                if (snapshot.empty) {
                    commentList.innerHTML = `<p class="text-center text-gray-500 p-4">还没有回音...</p>`;
                } else {
                    snapshot.forEach(doc => {
                        // FIX: Add a guard clause to prevent error if currentEmotion becomes null
                        // due to navigation while the listener is still active.
                        if (!currentEmotion) {
                            console.warn("Comment listener fired after navigation. Ignoring.");
                            return;
                        }

                        const comment = doc.data();
                        const isAuthor = comment.authorId === currentEmotion.authorId;
                        const commentEl = document.createElement('div');
                        commentEl.className = `p-3 my-2 rounded-lg ${isAuthor ? 'bg-teal-500/10' : 'bg-gray-800/50'}`;
                        commentEl.innerHTML = `
                            <p class="text-gray-200">${comment.text}</p>
                            <p class="text-xs text-right mt-1 ${isAuthor ? 'text-teal-400' : 'text-gray-400'}">${isAuthor ? `${comment.authorId} (星主)` : comment.authorId}</p>
                        `;
                        commentList.appendChild(commentEl);
                    });
                    commentList.scrollTop = commentList.scrollHeight;
                }
            }, (error) => {
                console.error("Error listening for comments:", error);
                commentList.innerHTML = `<p class="text-center text-red-500 p-4">无法加载回音</p>`;
            });
        }

        async function postComment() {
            const text = commentInput.value.trim();
            if (!text || !currentEmotion) return;
            postCommentButton.disabled = true;

            try {
                const commentsCol = collection(db, emotionsCol.path, currentEmotion.id, 'comments');
                await addDoc(commentsCol, {
                    text: text,
                    authorId: anonymousId,
                    createdAt: serverTimestamp()
                });
                
                const emotionDocRef = doc(db, emotionsCol.path, currentEmotion.id);
                await updateDoc(emotionDocRef, { commentCount: increment(1) });

                commentInput.value = '';
            } catch (error) {
                console.error("Error posting comment:", error);
            } finally {
                postCommentButton.disabled = false;
            }
        }

        // --- Event Listeners ---
        navDrift.addEventListener('click', showDriftPage);
        navProject.addEventListener('click', showProjectPage);
        navBack.addEventListener('click', () => {
            currentEmotion = null; 
            showDriftPage();
        });
        projectButton.addEventListener('click', projectEmotion);
        resonateButton.addEventListener('click', resonateWithEmotion);
        emotionCard.addEventListener('click', showDetailPage);
        postCommentButton.addEventListener('click', postComment);
        commentInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') postComment();
        });

        // --- Background Animation ---
        function createStars() {
            if (starContainer.children.length > 0) return;
            const count = 50;
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                star.style.animationDuration = `${Math.random() * 3 + 4}s`;
                starContainer.appendChild(star);
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            createStars();
            initializeFirebase();
        };
    </script>
</body>
</html>
